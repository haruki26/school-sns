// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../generated/prisma/"
}

datasource db {
  provider = "sqlserver"
  url = env("DATABASE_URL")
}

model Users {
  id String @id @default(uuid(4))
  userName String
  email String @unique
  passwordHash String?
  role String @default("STUDENT")
  bio String?
  avatarUrl String?
  googleId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  worldMembers WorldMembers[]

  userFollowerRelationships UserRelationships[] @relation("follower")
  userFolloweeRelationships UserRelationships[] @relation("followee")

  oauth2Token OAuthConnection[]

  artifacts Artifacts[]

  scraps Scraps[]

  comments Comments[]

  assets Assets[]

  mentions Mentions[]
}

model OAuthConnection {
  id           String   @id @default(uuid())
  user         Users    @relation(fields: [userId], references: [id])
  userId       String   @unique
  provider     String   @default("google")
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  updatedAt    DateTime @updatedAt
}

model UserRelationships {
  id String @id @default(uuid(4))
  follower Users @relation("follower", fields: [followerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  followerId String
  followee Users @relation("followee", fields: [followeeId], references: [id], onDelete: Cascade)
  followeeId String
  createdAt DateTime @default(now())

  @@unique([followerId, followeeId])
}

model Worlds {
  id String @id @default(uuid(4))
  name String
  description String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  worldMembers WorldMembers[]
}

model WorldMembers {
  id String @id @default(uuid(4))
  world Worlds @relation(fields: [worldId], references: [id])
  worldId String
  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  joinedAt DateTime @default(now())
}

model Artifacts {
  id String @id @default(uuid(4))
  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  title String
  body String
  summaryByAI String?
  status String @default("DRAFT")
  publishedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tagArtifacts TagArtifacts[]

  mentions Mentions[]

  comments Comments[]
}

model Scraps {
  id String @id @default(uuid(4))
  parent Scraps? @relation("ScrapToParent", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  parentId String?
  user Users @relation(fields: [userId], references: [id])
  userId String
  body String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scraps Scraps[] @relation("ScrapToParent")

  tagScraps TagScraps[]
}

model Comments {
  id String @id @default(uuid(4))
  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  parent Comments? @relation("CommentToParent", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  parentId String?
  artifact Artifacts @relation(fields: [artifactId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  artifactId String

  body String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  comments Comments[] @relation("CommentToParent")
}

model Tags {
  id String @id @default(uuid(4))
  name String @unique
  slug String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tagArtifacts TagArtifacts[]

  tagScraps TagScraps[]
}

model TagArtifacts {
  id String @id @default(uuid(4))
  artifact Artifacts @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  artifactId String
  tag Tags @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId String
  createdAt DateTime @default(now())
}

model Assets {
  id String @id @default(uuid(4))
  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  url String
  fileType String
  originalName String
  sizeBytes BigInt
  createdAt DateTime @default(now())
}

model Mentions {
  id String @id @default(uuid(4))
  artifact Artifacts @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  artifactId String
  user Users @relation(fields: [mentionedUserId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  mentionedUserId String
  createdAt DateTime @default(now())
}

model TagScraps {
  id String @id @default(uuid(4))
  scrap Scraps @relation(fields: [scrapId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  scrapId String
  tag Tags @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId String
  createdAt DateTime @default(now())
}
